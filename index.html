<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes">
  <title>Unity WebAR</title>
  <link rel="stylesheet" href="TemplateData/style.css">
  <style>
    html {
      height: -webkit-fill-available;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      width: 100vw;
      overflow: hidden;
      background-color: black;
    }

    .ctaDiv {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      z-index: 99;
    }

    button {
      margin-top: 15px;
      padding: 10px 25px;
      background: #008CFF;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background: #006fd6;
    }
  </style>
</head>
<body>
  <!-- Webcam feed -->
  <video id="webcam-video" muted autoplay playsinline style="width:1px;position:absolute"></video>
  <canvas id="video-canvas" style="width:100%; height:100%; object-fit:cover; position:absolute"></canvas>

  <!-- Permission screen -->
  <div id="startARDiv" class="ctaDiv">
    <p style="text-align:center; width:70vw">
      This AR experience requires access to your device's camera.
    </p>
    <button id="startARButton" onclick="StartAR()">ALLOW ACCESS</button>
  </div>

  <!-- Error screen -->
  <div id="errorDiv" class="ctaDiv" style="display:none; background:#a33;">
    <p id="errorText" style="text-align:center; width:70vw;"></p>
  </div>

  <!-- Unity Canvas -->
  <div id="unity-container" class="unity-mobile">
    <canvas id="unity-canvas"
            style="width: 100%; height: 100%; background: transparent; position:absolute; z-index:1;"></canvas>
  </div>

  <script src="arcamera.js" type="text/javascript"></script>
  <script src="wtracker.js" type="text/javascript"></script>
  <script src="Build/webar-smarthome.loader.js"></script>

  <script>
    // === INITIALIZE AR SYSTEM ===
    var initialize = async () => {
      const unityCanvas = document.querySelector("#unity-canvas");
      const videoCanvas = document.querySelector("#video-canvas");

      window.arCamera = new ARCamera(unityCanvas, videoCanvas);
      window.wTracker = new WorldTracker(arCamera);

      try {
        await wTracker.initialize("./opencv.js");
        console.log("World tracker initialized!");
      } catch (error) {
        console.error("Failed to initialize world tracker:", error);
        ShowError("Failed to initialize the World Tracker.<br>" + error);
        return;
      }

      await LoadWebcams();
    };

    initialize();

    // === START AR AFTER CAMERA ALLOWED ===
    async function StartAR() {
      document.getElementById('startARDiv').style.display = 'none';

      await RequestWebcam();
      StartMotionSensors();

      createUnityInstance(document.querySelector("#unity-canvas"), {
        dataUrl: "Build/webar-smarthome.data",
        frameworkUrl: "Build/webar-smarthome.framework.js",
          codeUrl: "Build/webar-smarthome.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "WebAR-SmartHome",
        productVersion: "0.1"
      }).then((unityInstance) => {
        window.unityInstance = unityInstance;
        console.log("Unity AR Scene Started");
        StartWebcam(); // Start camera after Unity loaded
      }).catch(err => {
        ShowError("Failed to start Unity AR Scene.<br>" + err);
      });
    }

    // === CAMERA SETTINGS ===
		window.unityFacingMode = "environment"
    window.WEBCAM_SETTINGS = {
      video: { facingMode: window.unityFacingMode },
      audio: false
    };

    async function RequestWebcam() {
      try {
        window.webcamStream = await navigator.mediaDevices.getUserMedia(window.WEBCAM_SETTINGS);
        arCamera.setFlipped(window.WEBCAM_SETTINGS.video.facingMode === 'user');
        console.log("Webcam access granted");
      } catch (err) {
        console.error("Camera access denied:", err);
        ShowError("Camera permission denied. Please refresh and allow access.");
      }
    }

    async function StartWebcam() {
      if (window.webcamStream) {
        const video = document.querySelector("#webcam-video");
        video.srcObject = webcamStream;
        try {
          await arCamera.startWebcam(video);
          console.log("Webcam started");
          window.unityInstance.SendMessage('ARCamera', 'OnStartWebcamSuccess');
        } catch (err) {
          console.error("Webcam failed:", err);
          window.unityInstance.SendMessage('ARCamera', 'OnStartWebcamFail');
        }
      }
    }

    async function LoadWebcams() {
      let devices = await navigator.mediaDevices.enumerateDevices();
      console.log("Cameras detected:", devices.filter(d => d.kind === "videoinput"));
    }

    function StartMotionSensors() {
      window.wTracker.startAngles()
        .then(() => console.log("Motion sensors started"))
        .catch(err => {
          console.error("Motion sensor error:", err);
          ShowError("Motion sensors not available on this device.");
        });
    }

    function ShowError(error) {
      document.getElementById("errorDiv").style.display = "flex";
      document.getElementById("errorText").innerHTML = error;
    }
  </script>
</body>
</html>
